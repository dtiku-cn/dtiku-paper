{%- import "macros/general.html.min.jinja" as general -%}
{%- import "macros/artalk.html.min.jinja" as artalk -%}
{%- import "macros/elements.html.min.jinja" as elements -%}
{%- import "macros/painter.html.min.jinja" as painter -%}
{%- import "macros/question.html.min.jinja" as question -%}
{%- import "macros/idiom.html.min.jinja" as idiom -%}
<!doctype html>
<html lang="zh">

<head>
    {% call general::meta() %}
    <title>{{idiom.detail.text}} | 高频{{idiom.detail.ty.text()}}积累 | {{global.config.site_title}}</title>
    {% call general::headerfiles() %}
    <style>
        .idiom-list {
            margin: 0;
        }

        .idiom-list td {
            vertical-align: middle !important;
        }

        .idiom-list tr>td:first-child {
            width: 5em;
        }

        .idiom-list tr>td:last-child {
            width: 4em;
        }

        .idiom-list td>p {
            margin: 0 !important;
        }

        .table .dropdown-toggle::after {
            transition: all .3s;
        }
    </style>
</head>

<body class="container">
    {% call general::header() %}
    <h1 id="idiom-{{idiom.detail.id}}" title="{{idiom.detail.text}}" class="text-center">
        <a rel="external nofollow" target="_blank"
            href="https://hanyu.sogou.com/result?query={{idiom.detail.text}}">{{idiom.detail.text}}</a>
    </h1>
    <div class="m-4 text-muted">
        {%if !idiom.detail.explain.baobian.is_empty()%}
        <span
            class='badge {%if idiom.detail.explain.baobian.contains("褒")%}badge-success{%elif idiom.detail.explain.baobian.contains("贬")%}badge-warning{%else%}badge-secondary{%endif%}'>
            {{idiom.detail.explain.baobian}}
        </span>
        {%endif%}
        <span>{{idiom.detail.explain.definition}}</span>
    </div>
    <nav class="nav nav-pills nav-fill" role="tablist">
        <a class="nav-link active" role="tab" data-toggle="pill" href="#sogou-explain">
            <img src="https://dlweb.sogoucdn.com/translate/favicon.ico" width="20" class="mr-2">
            <b>搜狗词典</b>
        </a>
        <a class="nav-link" role="tab" data-toggle="pill" href="#baidu-explain">
            <img src="https://www.baidu.com/favicon.ico" width="20" class="mr-2">
            <b>百度词典</b>
        </a>
    </nav>
    <div class="tab-content mt-3">
        <div class="tab-pane fade show active" id="sogou-explain" role="tabpanel">
            <div class="m-4 text-muted">{{idiom.detail.content.sogou.shiyidetail | safe}}</div>
            {%if !idiom.detail.content.sogou.liju.is_empty()%}
            <h3>例句</h3>
            <div class="m-4 text-muted">{{idiom.detail.content.sogou.liju | safe}}</div>
            {%endif%}
        </div>
        <div class="tab-pane fade" id="baidu-explain" role="tabpanel">
            {%if let BaiduIdiomExplainEntry::Idiom(i) = idiom.detail.content.baidu%}
            {%if let Some(d) = i.definition_info%}
            <p class="mx-4">
                <span class="badge badge-primary">基本释义</span>
                {{d.definition}}
            </p>
            {%if d.similar_definition.is_empty()%}
            <p class="mx-4">
                <span class="badge badge-danger">比喻</span>
                {{d.similar_definition}}
            </p>
            {%endif%}
            {%if d.modern_definition.is_empty()%}
            <p class="mx-4">
                <span class="badge badge-info">今义</span>
                {{d.modern_definition}}
            </p>
            {%endif%}
            <ul class="mx-4">
                {%for dm in d.detail_means%}
                <li>{{dm.word}}: {{dm.definition}}</li>
                {%endfor%}
            </ul>
            {%endif%}
            <ol class="ml-2">
                {%for lj in i.liju%}
                <li>{{lj.show_name | safe}}</li>
                {%endfor%}
            </ol>
            {% elif let BaiduIdiomExplainEntry::Term(t) = idiom.detail.content.baidu %}
            {% if let Some(cd) = t.comprehensive_definition.first() %}
            <ul class="nav nav-tabs" id="termTab" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="basicDefinition" data-toggle="tab"
                        data-target="#basicDefinitionContent" type="button" role="tab">基本释义</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="detailDefinition" data-toggle="tab"
                        data-target="#detailDefinitionContent" type="button" role="tab">详细释义</button>
                </li>
            </ul>
            <div class="tab-content card mb-3" id="termTabContent">
                <div class="tab-pane card-body fade show active" id="basicDefinitionContent" role="tabpanel">
                    {%for bd in cd.basic_definition%}
                    <p>{{bd.definition}}</p>
                    <p>
                        <span class="badge badge-primary">组词</span>
                        {%for zc in bd.zuci%}
                        <span>{{zc.name}}</span>
                        {%endfor%}
                    </p>
                    <p>
                        <span class="badge badge-info">例句</span>
                    <ul>
                        {%for lj in bd.liju%}
                        <li>{{lj.show_name | safe}}</li>
                        {%endfor%}
                    </ul>
                    </p>
                    <hr />
                    {%endfor%}
                </div>
                <div class="tab-pane card-body fade" id="detailDefinitionContent" role="tabpanel">
                    {%for dd in cd.detail_definition%}
                    <p>{{dd.definition}}</p>
                    <p>
                        <span class="badge badge-info">例句</span>
                    <ul>
                        {%for lj in dd.liju%}
                        <li>{{lj.show_name | safe}}</li>
                        {%endfor%}
                    </ul>
                    </p>
                    <div>
                        <span class="badge badge-primary">引证</span>
                        {%for cite in dd.cite_list%}
                        <p>
                            <span>{{cite.cite_original_text}}</span>
                            <span>{{cite.dynasty}} —— {{cite.author}} {{cite.source}}</span>
                        </p>
                        {%endfor%}
                    </div>
                    <hr />
                    {%endfor%}
                </div>
            </div>
            {%endif%}
            {%endif%}
        </div>
    </div>
    {%call idiom::jyc_fyc(idiom.detail.content.jyc(), idiom.detail.content.fyc(), idiom)%}
    <div class="card mb-3">
        <header class="d-flex card-header align-items-center">
            <svg class="icon-svg icon-svg-sm mr-2">
                <use xlink:href="#ic-list"></use>
            </svg>
            <b class="mr-auto">出处</b>
            <div class="custom-control custom-switch">
                <input type="checkbox" class="custom-control-input" id="unique-question">
                <label class="custom-control-label" for="unique-question" data-toggle="tooltip"
                    title="x中有y题重复">去除重复题目</label>
            </div>
        </header>
        <div class="table-responsive">
            <table class="table">
                <tr>
                    <th>真题试卷</th>
                    <th class="text-center px-0" style="width:5em">题号</th>
                </tr>
            {%for r in idiom.refs%}
            <tr id="q-{{r.question.id}}">
                <td class="p-1">
                    {%if global.config.show_vendor%}
                    <img class="vendor-icon" rel="external nofollow noreferrer" src="{r.refPaper.fromType.iconUrl()}"
                        alt="{r.refPaper.fromType.name()}" />
                    {%endif%}
                    <a class="btn btn-link dropdown-toggle text-left text-break" role="button" data-toggle="collapse"
                        href="#idiom-ref-{{r.id}}">{{r.paper.title}}</a>
                </td>
                <td class="text-center text-nowrap px-0 py-1">
                    <a class="text-nowrap" target="_blank" href="/paper/{{r.paper.id}}#q-{{r.sort}}">
                        第{{r.sort}}题
                        <svg class="icon-svg icon-svg-sm">
                            <use xlink:href="#ic-link"></use>
                        </svg>
                    </a>
                </td>
            </tr>
            <tr class="well collapse bg-light" id="idiom-ref-{{r.id}}">
                <td colspan="2" class="question-wrapper">{%call question::xingce_question(r.question)%}</td>
            </tr>
            {%endfor%}
            </table>
        </div>
    </div>
    {% call artalk::comment(true,true,true,"来这里吐槽一下")%}
    {% call general::footer() %}
    {% call painter::painter() %}
    {% call question::answer_collapse_action() %}
    {% call question::solution_comment_script() %}
    <script>
        $(function () {
            // 计算总题目数和重复题目数
            function calculateDuplicateStats() {
                var questionIdCount = {};
                var totalCount = 0;
                var duplicateCount = 0;
                
                // 统计每个 question.id 出现的次数
                $('tr[id^="q-"]').each(function() {
                    var id = $(this).attr('id');
                    var questionId = id.replace('q-', '');
                    totalCount++;
                    questionIdCount[questionId] = (questionIdCount[questionId] || 0) + 1;
                });
                
                // 计算重复的题目数（出现次数大于1的题目）
                for (var qid in questionIdCount) {
                    if (questionIdCount[qid] > 1) {
                        duplicateCount += questionIdCount[qid] - 1; // 每个重复题目减去第一个
                    }
                }
                
                return {
                    total: totalCount,
                    duplicate: duplicateCount
                };
            }
            
            // 更新 title
            function updateTitle() {
                var stats = calculateDuplicateStats();
                var titleText = stats.total + '中有' + stats.duplicate + '题重复';
                var $label = $('label[for="unique-question"]');
                $label.attr('title', titleText);
                
                // 重新渲染 tooltip
                try {
                    $label.tooltip('dispose'); // 销毁现有的 tooltip（如果已初始化）
                } catch (e) {
                    // tooltip 可能还没有初始化，忽略错误
                }
                $label.tooltip(); // 重新初始化 tooltip
            }
            
            // 页面加载时计算并更新 title
            updateTitle();
            
            $("#unique-question").click(function () {
                var val = $(this).is(':checked');
                var seenQuestionIds = new Set();
                
                // 遍历所有题目行
                $('tr[id^="q-"]').each(function() {
                    var $row = $(this);
                    var id = $row.attr('id');
                    var questionId = id.replace('q-', '');
                    
                    if (val) {
                        // 如果启用去重，隐藏重复的题目
                        if (seenQuestionIds.has(questionId)) {
                            // 隐藏题目行和对应的详情行
                            $row.addClass('d-none');
                            $row.next('tr[id^="idiom-ref-"]').addClass('d-none');
                        } else {
                            // 保留第一个，移除可能的隐藏状态
                            $row.removeClass('d-none');
                            $row.next('tr[id^="idiom-ref-"]').removeClass('d-none');
                            seenQuestionIds.add(questionId);
                        }
                    } else {
                        // 如果禁用去重，显示所有题目
                        $row.removeClass('d-none');
                        $row.next('tr[id^="idiom-ref-"]').removeClass('d-none');
                    }
                });
            });
            $('a[data-toggle="collapse"]').click(function () {
                $(this).closest('tr').toggleClass('dropup');
            });
        })
    </script>
</body>

</html>