{%- import "macros/general.html.min.jinja" as general -%}
{%- import "macros/artalk.html.min.jinja" as artalk -%}
{%- import "macros/painter.html.min.jinja" as painter -%}
{%- import "macros/issue.html.min.jinja" as issue -%}
{%- import "macros/paywall.html.jinja" as paywall -%}
<!doctype html>
<html lang="zh">

<head>
    {% call general::meta() %}
    <title>{{issue.title}} - è®ºå›äº¤æµ | {{global.config.site_title}}</title>
    {% call general::headerfiles() %}
    {% call issue::issue_detail_style() %}
    <style>
        #collect-container {
            min-height: 100vh;
            position: relative;
        }

        #collect-container.collapsed {
            overflow: hidden;
        }

        #collect-side {
            min-width: 280px;
            height: 100vh;
            transition: margin-left 0.3s ease-in-out;
            position: sticky;
            top: 0;
            overflow-y: auto;
            overflow-x: hidden;
        }

        #collect-side::-webkit-scrollbar {
            width: 6px;
        }

        #collect-side::-webkit-scrollbar-thumb {
            background: var(--secondary);
            border-radius: 3px;
        }

        #collect-container.collapsed #collect-side {
            margin-left: -280px;
        }

        #collect-container.collapsed #toggle-side {
            height: 100%;
            position: absolute;
        }

        .sidebar-handle {
            flex: 0 0 12px;
            border: 0;
            background: transparent;
            cursor: pointer;
            position: sticky;
            top: 0;
            height: 100vh;
            transition: background 0.15s ease-in-out;
        }

        .sidebar-handle:hover {
            background: var(--light);
        }

        /* ä½¿ç”¨ Bootstrap Nav æ ·å¼ */
        #collect-toc .nav {
            flex-direction: column;
        }

        #collect-toc .nav-link {
            position: relative;
            color: var(--dark);
            border-radius: 0.25rem;
            transition: all 0.15s ease-in-out;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            padding-left: 1.5rem !important;
        }

        #collect-toc .nav-link:hover {
            color: var(--primary);
            background: var(--light);
        }

        #collect-toc .nav-link.active {
            color: var(--primary);
            font-weight: 600;
            box-shadow: inset 3px 0px 0px var(--primary);
        }

        /* éšè— Bootstrap dropdown-toggle é»˜è®¤çš„å³ä¾§ç®­å¤´ */
        #collect-toc .nav-link.dropdown-toggle::after {
            display: none;
        }

        /* åœ¨å·¦ä¾§æ·»åŠ ç®­å¤´ï¼ˆå‚è€ƒ Bootstrap dropdown-toggle æ ·å¼ï¼‰ */
        #collect-toc .nav-link.dropdown-toggle::before {
            position: absolute;
            left: 0.5rem;
            top: 50%;
            margin-top: -0.3em;
            display: inline-block;
            content: "";
            border-top: 0.3em solid transparent;
            border-right: 0;
            border-bottom: 0.3em solid transparent;
            border-left: 0.3em solid;
            transition: transform 0.2s ease-in-out;
        }

        #collect-toc .nav-link.dropdown-toggle[aria-expanded="true"]::before {
            transform: rotate(90deg);
        }

        /* å­çº§æ·»åŠ ç¼©è¿› */
        #collect-toc .collapse {
            margin-left: 1rem;
        }

        #collect-toc .ml-3:before {
            content: '';
            display: block;
            border-left: 1px solid #dee2e6;
            position: absolute;
            left: -7px;
            top: 0;
            bottom: 0;
        }

        #collect-toc .ml-3 {
            position: relative;
        }

        /* åŠ è½½è’™å±‚ */
        #printcontent .loading-mask {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 4;
        }

        /* ä»˜è´¹å¢™æ ·å¼ */
        .paywall-preview::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 150px;
            background: linear-gradient(to bottom, rgba(255, 255, 255, 0) 0%, rgba(255, 255, 255, 0.95) 40%, rgba(255, 255, 255, 1) 70%);
            pointer-events: none;
        }

        @media print {
            .paywall-card,
            .paywall-preview::after {
                display: none !important;
            }
        }
    </style>
</head>

<body class="container">
    {% call general::header() %}
    <div class="card mb-3">
        <header class="card-header d-flex align-items-center py-2 pl-3 pr-2">
            <svg class="icon-svg icon-svg-md mr-2 d-print-none">
                <use xlink:href="#{{issue.topic.icon()}}"></use>
            </svg>
            <strong class="d-none d-md-block d-print-none">ã€{{issue.topic.text()}}ã€‘</strong>
            <strong class="mr-auto">
                <a class="text-reset text-decoration-none" href="/bbs/issue/{{issue.id}}">{{issue.title}}</a>
            </strong>
            {%if Some(*issue.user_id) == global.current_user_id()%}
            <a class="btn card-link d-flex align-items-center d-print-none" data-toggle="tooltip" title="é‡æ–°ç¼–è¾‘"
                href="/bbs/issue/{{issue.id}}/edit">
                <svg class="icon-svg icon-svg-sm mr-2">
                    <use xlink:href="#ic-post"></use>
                </svg>
                <b>ç¼–è¾‘</b>
            </a>
            {%endif%}
            <a class="btn card-link ml-0 d-lg-flex align-items-center d-none d-print-none"
                href="{%if global.user.is_none()%}#loginModal{%else%}javascript:window.print(){%endif%}"
                data-toggle="{%if global.user.is_none()%}modal{%endif%}">
                <svg class="icon-svg icon-svg-sm mr-2">
                    <use xlink:href="#ic-printer"></use>
                </svg>
                <b>æ‰“å°</b>
            </a>
        </header>
        {%if issue.collect%}
        <div id="collect-container" class="d-flex">
            <aside id="collect-side" class="bg-light border-right d-none d-sm-block d-print-none">
                <div class="p-3 border-bottom bg-white sticky-top">
                    <h6 class="mb-0 text-muted">ğŸ“š ç›®å½•</h6>
                </div>
                <nav id="collect-toc" class="p-2">{{issue.toc | markdown | safe}}</nav>
            </aside>
            <button id="toggle-side" class="sidebar-handle border-left d-none d-sm-block d-print-none" title="æ”¶èµ·/å±•å¼€ä¾§è¾¹æ "
                aria-label="åˆ‡æ¢ä¾§è¾¹æ ">âŸ¨</button>
            <div id="printcontent" class="card-body vditor-reset">
                {%call paywall::render_paid_content(issue, global, 300) %}
            </div>
        </div>
        {%else%}
        <div id="printcontent" class="card-body vditor-reset">
            {%call paywall::render_paid_content(issue, global, 300) %}
        </div>
        {%endif%}
        <footer class="card-footer d-flex align-items-center d-print-none">
            <div class="d-flex align-items-center mr-auto">
                {% if let Some(u)=issue.user %}
                <img id="{{u.id}}" class="border rounded-circle mr-2" style="height:2em" data-toggle="tooltip"
                    src="{{u.avatar}}" title="{{u.name}}" alt="{{u.name}}" />
                {% endif %}
                <b class="d-none d-md-block">{{issue.author_name()}}</b>
                <span data-toggle="tooltip"
                    title='{{issue.created | datetime_fmt("%Y-%m-%d %H:%M")}}'>å‘å¸ƒäº{{issue.created |
                    format_with_now}}</span>
                {% if issue.created != issue.modified %}
                <span class="d-none d-sm-block">&nbsp; | &nbsp;</span>
                <span class="d-none d-sm-block" data-toggle="tooltip"
                    title='{{issue.modified | datetime_fmt("%Y-%m-%d %H:%M")}}'>æ›´æ–°äº{{issue.modified |
                    format_with_now}}</span>
                {% endif %}
            </div>
            <div class="artalk-page-vote d-flex">
                <a id="agree" class="card-link d-flex align-items-center artalk-page-vote-up" title="èµåŒæ•°"
                    data-toggle="{%if global.user.is_none()%}modal{%else%}tooltip{%endif%}"
                    href="{%if global.user.is_none()%}#loginModal{%else%}javascript:void(0){%endif%}">
                    <svg class="icon-svg icon-svg-md mr-2">
                        <use xlink:href="#ic-agree"></use>
                    </svg>
                    <b class="agree-count artalk-page-vote-up-count"></b>
                </a>
                <a id="disagree" class="card-link d-flex align-items-center artalk-page-vote-down" title="åå¯¹æ•°"
                    data-toggle="{%if global.user.is_none()%}modal{%else%}tooltip{%endif%}"
                    href="{%if global.user.is_none()%}#loginModal{%else%}javascript:void(0){%endif%}">
                    <svg class="icon-svg icon-svg-md mr-2">
                        <use xlink:href="#ic-disagree"></use>
                    </svg>
                    <b class="agree-count artalk-page-vote-down-count"></b>
                </a>
            </div>
        </footer>
        <div id='toc-table' class='d-print-none'></div>
    </div>
    {% call artalk::comment(true,true,true,"æ¥è¿™é‡Œåæ§½ä¸€ä¸‹")%}
    {% call general::footer() %}
    {% call issue::issue_detail_script() %}
    {# painterè¦æ”¾åœ¨window.floatButtonAddonä¸‹é¢åŠ è½½ #}
    {%if issue.collect%}
    <script>
        $(function () {
            window.floatButtonAddon = [{
                style: 'always',
                render: function () {
                    return "<div id='toc-btn' class='d-flex align-items-center'>" +
                        "<svg class='icon-svg'><use xlink:href='#ic-toc'></use></svg>" +
                        "</div>";
                },
                click: function () {
                    $("#toc-table").fadeToggle();
                }
            }]
        })
    </script>
    {%else%}
    <script>
        $(function () {
            const toc_size = $("#toc-table .toc-list-item").size();
            if (toc_size && toc_size > 1) {
                window.floatButtonAddon = [{
                    style: 'always',
                    render: function () {
                        return "<div id='toc-btn' class='d-flex align-items-center'>" +
                            "<svg class='icon-svg'><use xlink:href='#ic-toc'></use></svg>" +
                            "</div>";
                    },
                    click: function () {
                        $("#toc-table").fadeToggle();
                    }
                }]
            } else {
                $("#toc-table").remove();
            }
        })
    </script>
    {%endif%}
    {% call painter::painter() %}
    <script>
        function rerender_collect_toc() {
            let counter = 0;

            // ä¸ºæ‰€æœ‰ ul æ·»åŠ  Bootstrap nav ç±»
            $('#collect-toc ul').addClass('nav flex-column');

            // ä¸ºæ‰€æœ‰ li æ·»åŠ  Bootstrap nav-item ç±»
            $('#collect-toc li').addClass('nav-item');

            // æ„å»ºæŠ˜å  TOC
            $('#collect-toc li').each(function () {
                const $li = $(this);
                const $subUl = $li.children('ul');
                const $a = $li.children('a').first();

                // ä¸ºæ‰€æœ‰é“¾æ¥æ·»åŠ  Bootstrap nav-link ç±»
                if ($a.length) {
                    $a.addClass('nav-link py-1 px-2 text-truncate');

                    // æ·»åŠ  title å±æ€§æ˜¾ç¤ºå®Œæ•´æ–‡æœ¬
                    const fullText = $a.text().trim();
                    if (fullText) {
                        $a.attr('title', fullText);
                    }
                }

                if ($subUl.length) {
                    counter++;
                    const collapseId = "toc-collapse-" + counter;

                    // ä½¿ç”¨ Bootstrap çš„ collapse å’Œé—´è·ç±»
                    $subUl.wrap(`<div class="collapse ml-3" id="${collapseId}"></div>`);

                    if ($a.length) {
                        // ä½¿ç”¨ Bootstrap çš„ dropdown-toggle ç±»
                        $a.addClass('dropdown-toggle');

                        // ä¿å­˜åŸå§‹ href
                        const href = $a.attr('href');
                        $a.attr('data-href', href);

                        // æ”¹é€ ä¸ºæŠ˜å æ§åˆ¶
                        $a.attr({
                            'href': '#' + collapseId,
                            'data-toggle': 'collapse',
                            'role': 'button',
                            'aria-expanded': 'false',
                            'aria-controls': collapseId
                        });
                    } else {
                        // å¦‚æœæ²¡æœ‰ aï¼Œåˆ›å»ºä¸€ä¸ªå¸¦ Bootstrap ç±»çš„é“¾æ¥
                        let text = $li.clone().children().remove().end().text().trim();
                        if (text) {
                            const $toggle = $(`
<a href="#${collapseId}" class="nav-link py-1 px-2 dropdown-toggle" data-toggle="collapse" role="button" aria-expanded="false" aria-controls="${collapseId}" title="${text}">
${text}
</a>
                `);
                            $li.contents().filter(function () {
                                return this.nodeType === 3 && this.nodeValue.trim() === text;
                            }).remove();
                            $li.prepend($toggle);
                        }
                    }
                }
            });
        }
        $(function () {
            rerender_collect_toc();

            // é«˜äº®å½“å‰æ¿€æ´»é¡¹ï¼ˆä½¿ç”¨ Bootstrap active ç±»ï¼‰
            function highlightActiveItem(href) {
                $('#collect-toc .nav-link').removeClass('active');
                const $activeLink = $('#collect-toc a[data-href="' + href + '"], #collect-toc a[href="' + href + '"]');
                $activeLink.addClass('active');

                // ç¡®ä¿æ¿€æ´»é¡¹çš„çˆ¶çº§æŠ˜å é¢æ¿å±•å¼€
                $activeLink.parents('.collapse').addClass('show').each(function () {
                    const id = $(this).attr('id');
                    $(`a[aria-controls="${id}"]`).attr('aria-expanded', 'true');
                });

                // æ»šåŠ¨åˆ°å¯è§åŒºåŸŸ
                if ($activeLink.length) {
                    const sidebar = document.getElementById('collect-side');
                    if (sidebar) {
                        const linkElement = $activeLink[0];
                        const sidebarRect = sidebar.getBoundingClientRect();
                        const linkRect = linkElement.getBoundingClientRect();

                        if (linkRect.top < sidebarRect.top || linkRect.bottom > sidebarRect.bottom) {
                            linkElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }
                    }
                }
            }

            // ç‚¹å‡» TOC é“¾æ¥è§¦å‘ AJAX
            $('#collect-toc').on('click', 'a', function (e) {
                e.preventDefault(); // é˜»æ­¢è·³è½¬
                const href = $(this).attr('href');

                let data_href = $(this).attr('data-href');
                // å¦‚æœæ˜¯æŠ˜å é“¾æ¥ï¼ˆ#å¼€å¤´ï¼‰ï¼Œé˜»æ­¢é»˜è®¤æŠ˜å è·³è½¬
                if (href.startsWith('#')) {
                    $(href).collapse('toggle'); // è°ƒç”¨ Bootstrap æŠ˜å 

                    if (!data_href) {
                        return
                    }
                } else {
                    data_href = href;
                }

                if ($("#printcontent").data("current-href") === data_href) {
                    return;
                }

                var $mask = $(`
<div class="loading-mask">
    <div class="spinner-border text-primary" role="status">
        <span class="sr-only">åŠ è½½ä¸­...</span>
    </div>
</div>
`);
                $("#printcontent").append($mask);

                // å‘èµ· AJAX è¯·æ±‚
                $.ajax({
                    url: `${data_href}?html=true`,
                    method: 'GET',
                    headers: {
                        'Accept': 'text/html+fragment'
                    },
                    success: function (data) {
                        $("#printcontent").html(data); // å°†è¯·æ±‚çš„ HTML æ¸²æŸ“åˆ° toc å…ƒç´ ä¸‹
                        tocbot.refresh();
                        $("#printcontent").data("current-href", data_href);

                        // é«˜äº®å½“å‰é¡¹
                        highlightActiveItem(data_href);

                        const toc_size = $("#toc-table .toc-list-item").size();
                        if (toc_size && toc_size > 1) {
                            $("#toc-table").show()
                        } else {
                            $("#toc-table").hide()
                        }

                        // å¹³æ»‘æ»šåŠ¨åˆ°é¡¶éƒ¨
                        $("#printcontent").get(0).scrollIntoView({ behavior: 'smooth', block: 'start' });
                    },
                    error: function (xhr, status, error) {
                        console.error('åŠ è½½å¤±è´¥:', error);
                        // å¯ä»¥åœ¨è¿™é‡Œæ˜¾ç¤ºé”™è¯¯æç¤º
                    },
                    complete: function () {
                        // ç§»é™¤é®ç½©
                        $mask.remove();
                    }
                });
            });

            const $layout = $('#collect-container');
            const $btn = $('#toggle-side');
            const SIDEBAR_STORAGE_KEY = 'sidebar_collapsed_state';

            function updateBtn() {
                if ($layout.hasClass('collapsed')) {
                    $btn.text('âŸ©'); // å±•å¼€ç®­å¤´
                    $btn.attr('title', 'å±•å¼€ä¾§è¾¹æ ');
                } else {
                    $btn.text('âŸ¨'); // æ”¶èµ·ç®­å¤´
                    $btn.attr('title', 'æ”¶èµ·ä¾§è¾¹æ ');
                }
            }

            function saveSidebarState() {
                try {
                    localStorage.setItem(SIDEBAR_STORAGE_KEY, $layout.hasClass('collapsed') ? 'true' : 'false');
                } catch (e) {
                    console.warn('æ— æ³•ä¿å­˜ä¾§è¾¹æ çŠ¶æ€:', e);
                }
            }

            function restoreSidebarState() {
                try {
                    const collapsed = localStorage.getItem(SIDEBAR_STORAGE_KEY);
                    if (collapsed === 'true') {
                        $layout.addClass('collapsed');
                    }
                } catch (e) {
                    console.warn('æ— æ³•æ¢å¤ä¾§è¾¹æ çŠ¶æ€:', e);
                }
            }

            $btn.on('click', function () {
                $layout.toggleClass('collapsed');
                updateBtn();
                saveSidebarState();
            });

            // æ¢å¤ä¾§è¾¹æ çŠ¶æ€
            restoreSidebarState();
            updateBtn();

            // é”®ç›˜å¿«æ·é”®ï¼šCtrl/Cmd + B åˆ‡æ¢ä¾§è¾¹æ 
            $(document).on('keydown', function (e) {
                if ((e.ctrlKey || e.metaKey) && e.key === 'b') {
                    e.preventDefault();
                    $btn.click();
                }
            });
        });
    </script>

</body>

</html>