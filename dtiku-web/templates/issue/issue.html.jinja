{%- import "macros/general.html.min.jinja" as general -%}
{%- import "macros/artalk.html.min.jinja" as artalk -%}
{%- import "macros/painter.html.min.jinja" as painter -%}
{%- import "macros/issue.html.min.jinja" as issue -%}
<!doctype html>
<html lang="zh">

<head>
    {% call general::meta() %}
    <title>{{issue.title}} - 论坛交流 | {{global.config.site_title}}</title>
    {% call general::headerfiles() %}
    {% call issue::issue_detail_style() %}
    <style>
        #collect-container {
            min-height: 100vh;
            --handle: 12px;
            position: relative;
        }

        #collect-side {
            min-width: 260px;
            height: 100vh;
            border-right: 1px solid var(--light);
            transition: margin-left 0.25s ease;
            position: sticky;
            top: 0;
        }

        #collect-container.collapsed {
            overflow: hidden;
        }

        #collect-container.collapsed #collect-side {
            margin-left: -260px;
        }

        #collect-container.collapsed .sidebar-handle {
            height: 100%;
            position: absolute;
            width: 12px;
            bottom: 0;
        }

        .sidebar-handle {
            flex: 0 0 var(--handle);
            border: 0;
            background: transparent;
            cursor: pointer;
            position: relative;
            padding: 0;
            position: sticky;
            top: 0;
            height: 100vh;
        }

        .sidebar-handle::before {
            content: "";
            position: absolute;
            inset: 0;
            border-left: 1px solid var(--light);
            z-index: 1;
        }

        .sidebar-handle:hover {
            background: rgba(120, 120, 120, 0.2);
        }


        /* 去掉默认 ul/li 样式 */
        #collect-toc ul {
            list-style: none;
            padding-left: 0;
            margin-left: 0;
        }

        #collect-toc li {
            margin: 0.25em 0;
            line-height: 1.5;
        }

        /* 折叠触发器样式 */
        .toc-toggle {
            display: inline-block;
            cursor: pointer;
            text-decoration: none;
            color: #007bff;
            border-radius: 4px;
            transition: background 0.2s;
        }

        .toc-toggle:hover {
            background: #e9ecef;
            text-decoration: none;
        }

        /* 子级缩进 */
        #collect-toc .ms-3 {
            padding-left: 1.2em;
            border-left: 1px solid #dee2e6;
            /* 轻微竖线分层 */
        }

        #toc {
            position: relative;
        }

        #toc .loading-mask {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
        }
    </style>
</head>

<body class="container">
    {% call general::header() %}
    {%if issue.collect%}
    <div id="collect-container" class="d-flex">
        <aside id="collect-side" class="card-header d-none d-sm-block d-print-none">
            <header class="d-flex align-items-center mb-2">
                <svg class="icon-svg icon-svg-md mr-2">
                    <use xlink:href="#{{issue.topic.icon()}}"></use>
                </svg>
                <strong class="d-none d-md-block d-print-none">【{{issue.topic.text()}}】</strong>
                <strong class="mr-auto">{{issue.title}}</strong>
            </header>
            <div id="collect-toc">{{issue.toc | markdown | safe}}</div>
        </aside>
        <button id="toggle-side" class="sidebar-handle d-none d-sm-block d-print-none" title="收起/展开侧边栏">⟨</button>
        <div id="toc" class="card-body vditor-reset">{{issue.html|safe}}</div>
    </div>
    <footer class="card-footer d-flex align-items-center d-print-none">
        <div class="d-flex align-items-center mr-auto">
            {% if let Some(u)=issue.user %}
            <img id="{{u.id}}" class="border rounded-circle mr-2" style="height:2em" data-toggle="tooltip"
                src="{{u.avatar}}" title="{{u.name}}" alt="{{u.name}}" />
            {% endif %}
            <b class="d-none d-md-block">{{issue.author_name()}}</b>
            <span data-toggle="tooltip"
                title='{{global.format(issue.created, "%Y-%m-%d %H:%M")}}'>发布于{{global.format_with_now(issue.created)}}</span>
            {% if issue.created != issue.modified %}
            <span class="d-none d-sm-block">&nbsp; | &nbsp;</span>
            <span class="d-none d-sm-block" data-toggle="tooltip"
                title='{{global.format(issue.modified, "%Y-%m-%d %H:%M")}}'>更新于{{global.format_with_now(issue.modified)}}</span>
            {% endif %}
        </div>
        <div class="artalk-page-vote d-flex">
            <a id="agree" class="card-link d-flex align-items-center artalk-page-vote-up" title="赞同数"
                data-toggle="{%if global.user.is_none()%}modal{%else%}tooltip{%endif%}"
                href="{%if global.user.is_none()%}#loginModal{%else%}javascript:void(0){%endif%}">
                <svg class="icon-svg icon-svg-md mr-2">
                    <use xlink:href="#ic-agree"></use>
                </svg>
                <b class="agree-count artalk-page-vote-up-count"></b>
            </a>
            <a id="disagree" class="card-link d-flex align-items-center artalk-page-vote-down" title="反对数"
                data-toggle="{%if global.user.is_none()%}modal{%else%}tooltip{%endif%}"
                href="{%if global.user.is_none()%}#loginModal{%else%}javascript:void(0){%endif%}">
                <svg class="icon-svg icon-svg-md mr-2">
                    <use xlink:href="#ic-disagree"></use>
                </svg>
                <b class="agree-count artalk-page-vote-down-count"></b>
            </a>
        </div>
    </footer>
    <div id='toc-table' class='d-print-none'></div>
    {%else%}
    <div class="card mb-3">
        <header class="card-header d-flex align-items-center py-2 pl-3 pr-2">
            <svg class="icon-svg icon-svg-md mr-2 d-print-none">
                <use xlink:href="#{{issue.topic.icon()}}"></use>
            </svg>
            <strong class="d-none d-md-block d-print-none">【{{issue.topic.text()}}】</strong>
            <strong class="mr-auto">{{issue.title}}</strong>
            {%if Some(*issue.user_id) == global.current_user_id()%}
            <a class="btn card-link d-flex align-items-center d-print-none" data-toggle="tooltip" title="重新编辑"
                href="/bbs/issue/{{issue.id}}/edit">
                <svg class="icon-svg icon-svg-sm mr-2">
                    <use xlink:href="#ic-post"></use>
                </svg>
                <b>编辑</b>
            </a>
            {%endif%}
            <a class="btn card-link ml-0 d-lg-flex align-items-center d-none d-print-none"
                href="{%if global.user.is_none()%}#loginModal{%else%}javascript:window.print(){%endif%}"
                data-toggle="{%if global.user.is_none()%}modal{%endif%}">
                <svg class="icon-svg icon-svg-sm mr-2">
                    <use xlink:href="#ic-printer"></use>
                </svg>
                <b>打印</b>
            </a>
        </header>
        <div id="toc" class="card-body vditor-reset">{{issue.html|safe}}</div>
        <footer class="card-footer d-flex align-items-center d-print-none">
            <div class="d-flex align-items-center mr-auto">
                {% if let Some(u)=issue.user %}
                <img id="{{u.id}}" class="border rounded-circle mr-2" style="height:2em" data-toggle="tooltip"
                    src="{{u.avatar}}" title="{{u.name}}" alt="{{u.name}}" />
                {% endif %}
                <b class="d-none d-md-block">{{issue.author_name()}}</b>
                <span data-toggle="tooltip"
                    title='{{global.format(issue.created, "%Y-%m-%d %H:%M")}}'>发布于{{global.format_with_now(issue.created)}}</span>
                {% if issue.created != issue.modified %}
                <span class="d-none d-sm-block">&nbsp; | &nbsp;</span>
                <span class="d-none d-sm-block" data-toggle="tooltip"
                    title='{{global.format(issue.modified, "%Y-%m-%d %H:%M")}}'>更新于{{global.format_with_now(issue.modified)}}</span>
                {% endif %}
            </div>
            <div class="artalk-page-vote d-flex">
                <a id="agree" class="card-link d-flex align-items-center artalk-page-vote-up" title="赞同数"
                    data-toggle="{%if global.user.is_none()%}modal{%else%}tooltip{%endif%}"
                    href="{%if global.user.is_none()%}#loginModal{%else%}javascript:void(0){%endif%}">
                    <svg class="icon-svg icon-svg-md mr-2">
                        <use xlink:href="#ic-agree"></use>
                    </svg>
                    <b class="agree-count artalk-page-vote-up-count"></b>
                </a>
                <a id="disagree" class="card-link d-flex align-items-center artalk-page-vote-down" title="反对数"
                    data-toggle="{%if global.user.is_none()%}modal{%else%}tooltip{%endif%}"
                    href="{%if global.user.is_none()%}#loginModal{%else%}javascript:void(0){%endif%}">
                    <svg class="icon-svg icon-svg-md mr-2">
                        <use xlink:href="#ic-disagree"></use>
                    </svg>
                    <b class="agree-count artalk-page-vote-down-count"></b>
                </a>
            </div>
        </footer>
        <div id='toc-table' class='d-print-none'></div>
    </div>
    {%endif%}
    {% call artalk::comment(true,true,true,"来这里吐槽一下")%}
    {% call general::footer() %}
    {% call issue::issue_detail_script() %}
    {# painter要放在window.floatButtonAddon下面加载 #}
    {% call painter::painter() %}
    <script>
        $(function () {
            let counter = 0;

            // 构建折叠 TOC
            $('#collect-toc li').each(function () {
                const $li = $(this);
                const $subUl = $li.children('ul');

                if ($subUl.length) {
                    counter++;
                    const collapseId = "toc-collapse-" + counter;

                    $subUl.wrap(`<div class="collapse ms-3" id="${collapseId}"></div>`);

                    let text = $li.clone().children().remove().end().text().trim();

                    if (text) {
                        const $toggle = $(`
<a href="#${collapseId}" class="toc-toggle" data-toggle="collapse" role="button" aria-expanded="false" aria-controls="${collapseId}">
${text}
</a>
        `);
                        $li.contents().filter(function () {
                            return this.nodeType === 3 && this.nodeValue.trim() === text;
                        }).remove();
                        $li.prepend($toggle);
                    }
                }
            });

            // 点击 TOC 链接触发 AJAX
            $('#collect-toc').on('click', 'a', function (e) {
                const href = $(this).attr('href');

                // 如果是折叠链接（#开头），阻止默认折叠跳转
                if (href.startsWith('#')) {
                    e.preventDefault(); // 阻止跳转
                    $(href).collapse('toggle'); // 调用 Bootstrap 折叠
                    return;
                }

                e.preventDefault();

                var $mask = $(`
<div class="loading-mask">
    <div class="spinner-border text-primary" role="status">
    <span class="sr-only">Loading...</span>
    </div>
</div>
`);
                $('#toc').append($mask);
                // 发起 AJAX 请求
                $.get(`${href}?html=true`, function (data) {
                    $('#toc').html(data); // 将请求的 HTML 渲染到 toc 元素下
                }).always(function () {
                    // 移除遮罩
                    $mask.remove();
                });
            });

            const $layout = $('#collect-container');
            const $btn = $('#toggle-side');

            function updateBtn() {
                if ($layout.hasClass('collapsed')) {
                    $btn.text('⟩'); // 展开箭头
                } else {
                    $btn.text('⟨'); // 收起箭头
                }
            }

            $btn.on('click', function () {
                $layout.toggleClass('collapsed');
                updateBtn();
            });

            updateBtn();
        });
    </script>

</body>

</html>