{%- import "macros/general.html.min.jinja" as general -%}
<!doctype html>
<html lang="zh">

<head>
    {% call general::meta() %}
    <title>è®ºå›ç¼–è¾‘å™¨ | {{global.config.site_title}}</title>
    {% call general::headerfiles() %}
    <link rel="stylesheet" href="/static/vendor/vditor/3.10.4/dist/index.min.css">
    <style>
        #editor img,
        #editor object {
            display: block;
            margin: 0 auto;
        }

        .vditor-reset,
        .vditor-reset table tr,
        .vditor-reset table tbody tr:nth-child(2n) {
            color: inherit !important;
            background-color: inherit;
        }

        .vditor-reset table td,
        .vditor-reset table th {
            word-break: break-word;
            white-space: pre-wrap;
        }
    </style>
</head>

<body class="container">
    {% call general::header() %}
    <form id="form" class="card mb-3" method="post"
        action="{%if let Some(i)=issue%}/bbs/issue/{{i.id}}{%else%}/bbs/issue{%endif%}">
        <header class="card-header d-flex flex-wrap p-1 align-items-center">
            <div class="input-group col-12 col-lg-4 p-0 pr-lg-2">
                <select class="custom-select" name="topic" required>
                    <option selected value="">-é€‰æ‹©ä¸€ä¸ªä¸»é¢˜-</option>
                    {%for t in TopicType::iter() %}
                    {%if issue.is_topic(t)%}
                    <option value="{{t}}" selected>{{t.text()}}</option>
                    {%else%}
                    <option value="{{t}}">{{t.text()}}</option>
                    {%endif%}
                    {%endfor%}
                </select>
                <div class='tooltip-topic invalid-tooltip'>ä¸èƒ½ä¸ºç©º</div>
            </div>
            <div class="input-group col-12 col-lg-8 p-0 mt-2 mt-lg-0">
                <input name="title" type="text" class="form-control" placeholder="è¾“å…¥æ ‡é¢˜"
                    value="{%if let Some(i)=issue%}{{i.title}}{%endif%}" required>
                <div class='tooltip-title invalid-tooltip'>ä¸èƒ½ä¸ºç©º</div>
                <div class="input-group-append">
                    <div class="input-group-text">
                        {% if let Some(i)=issue %}{% if i.paid %}
                        <input type="checkbox" name="paid" value="true" checked />
                        {% else %}
                        <input type="checkbox" name="paid" value="true" />
                        {% endif %}
                        {% else %}
                        <input type="checkbox" name="paid" value="true" />
                        {% endif %}
                        <label class="ml-1 mb-0" style="cursor: pointer;">ä»˜è´¹</label>
                    </div>
                    <div class="input-group-text">
                        {% if let Some(i)=issue %}
                        {% if i.collect %}
                        <input id="collect-checkbox" type="checkbox" name="collect" value="true" checked />
                        {% else %}
                        <input id="collect-checkbox" type="checkbox" name="collect" value="true" />
                        {% endif %}
                        {% else %}
                        <input id="collect-checkbox" type="checkbox" name="collect" value="true" />
                        {% endif %}
                        <label class="ml-1 mb-0" style="cursor: pointer;">åˆé›†</label>
                    </div>
                    <input id="preview" type="button" class="btn btn-success" value="é¢„è§ˆ" />
                    <input id="submit" type="submit" class="btn btn-primary d-none" value="æäº¤" />
                </div>
            </div>
        </header>
        <div class="card-body p-0">
            <!-- åˆé›†æ¨¡å¼çš„ç›®å½•ç¼–è¾‘å™¨ -->
            <div id="collect-toc-container" style="display: none;">
                <div class="p-3 border-bottom bg-light">
                    <h6 class="mb-1"><strong>ğŸ“‘ ç›®å½• (TOC)</strong></h6>
                    <small class="text-muted">
                        ä½¿ç”¨ Markdown æ ¼å¼ç¼–å†™ç›®å½•ï¼Œæ”¯æŒé“¾æ¥æ ¼å¼å¦‚ï¼š- [æ ‡é¢˜](/bbs/issue/id)
                    </small>
                </div>
                <div id="toc-editor" style="height: 30vh"></div>
                
                <div class="p-3 border-bottom border-top bg-light">
                    <h6 class="mb-1"><strong>ğŸ¨ å°é¢å†…å®¹ (Content)</strong></h6>
                    <small class="text-muted">
                        ä½¿ç”¨ Markdown æ ¼å¼ç¼–å†™å°é¢å†…å®¹ï¼Œæ”¯æŒ PlantUML ç­‰æ‰©å±•è¯­æ³•
                    </small>
                </div>
            </div>
            
            <!-- å…±ç”¨çš„å†…å®¹ç¼–è¾‘å™¨ -->
            <div id="editor" data-toggle="tooltip"></div>
        </div>
    </form>
    {% call general::footer() %}
    <script src="/static/vendor/vditor/3.10.4/dist/index.min.js"></script>
    <script type="module" defer src="/static/vendor/venny/venny.esm.js"></script>
    <script>
        $(function () {
            var isCollect = {%if let Some(i)=issue%}{{i.collect | json | safe}}{%else%}false{%endif%};
            var eEditor = document.querySelector('#editor');
            var eTocContainer = document.querySelector('#collect-toc-container');
            var eTocEditor = document.querySelector('#toc-editor');
            
            // VEditor å®ä¾‹
            window.tocEditor = null;
            
            /**
             * åˆ›å»º Vditor ç¼–è¾‘å™¨å®ä¾‹çš„é€šç”¨æ–¹æ³•
             * @param {HTMLElement} element - ç¼–è¾‘å™¨å®¹å™¨å…ƒç´ 
             * @param {Object} options - ç¼–è¾‘å™¨é…ç½®é€‰é¡¹
             * @returns {Vditor} Vditor å®ä¾‹
             */
            function createVditor(element, options) {
                var defaultConfig = {
                    width: '100%',
                    cdn: 'https://{{global.original_host}}/static/vendor/vditor/3.10.4',
                    theme: window.themeSwitcher.getTheme() ? 'dark' : 'light',
                    preview: {
                        theme: window.themeSwitcher.getTheme() ? 'dark' : 'light',
                        path: '/static/vendor/vditor/3.10.4/dist/content-theme',
                        math: { engine: 'MathJax', inlineDigit: true },
                        actions: []
                    },
                    upload: {
                        url: "https://s.dtiku.cn/dtiku-alist-api/upload",
                        fieldName: 'file',
                        multiple: false,
                        format: (f, respTxt) => `{"msg":"","code":0,"data":{"errFiles":[],"succMap":{"${f[0].name}":"${respTxt}"}}}`,
                        linkToImgUrl: "https://s.dtiku.cn/dtiku-alist-api/upload-by-link"
                    }
                };
                
                // åˆå¹¶é…ç½®
                var config = Object.assign({}, defaultConfig, options);
                return new Vditor(element, config);
            }
            
            // åˆ‡æ¢ç¼–è¾‘å™¨æ˜¾ç¤º
            function toggleEditor() {
                if (!window.vEditor) {
                    console.warn('vEditor not ready yet');
                    return;
                }
                
                var collectChecked = $('#collect-checkbox').is(':checked');
                if (collectChecked) {
                    // æ˜¾ç¤º TOC å®¹å™¨ï¼Œè°ƒæ•´ä¸»ç¼–è¾‘å™¨é«˜åº¦
                    $('#collect-toc-container').show();
                    // æ‰¾åˆ° vditor å®é™…å®¹å™¨å¹¶è°ƒæ•´é«˜åº¦
                    $('#editor').find('.vditor').css('height', '70vh');
                    
                    // å»¶è¿Ÿåˆå§‹åŒ– TOC ç¼–è¾‘å™¨
                    if (!window.tocEditor) {
                        initTocEditor();
                    }
                } else {
                    // éšè— TOC å®¹å™¨ï¼Œæ¢å¤ä¸»ç¼–è¾‘å™¨é«˜åº¦
                    $('#collect-toc-container').hide();
                    $('#editor').find('.vditor').css('height', '100vh');
                }
            }
            
            // åˆå§‹åŒ– TOC ç¼–è¾‘å™¨
            function initTocEditor() {
                var tocInitValue = {%if let Some(i) = issue %}{%if i.collect%}{{ i.toc | json | safe }}{%else%}''{%endif%}{%else%}''{% endif %};
                
                window.tocEditor = createVditor(eTocEditor, {
                    height: '30vh',
                    placeholder: 'åœ¨è¿™é‡Œè¾“å…¥ç›®å½•å†…å®¹...\nä¾‹å¦‚ï¼š\n- [ä»€ä¹ˆæ˜¯ç”³è®º](/bbs/issue/83)\n- [ç”³è®ºææ–™é˜…è¯»æŠ€å·§](/bbs/issue/84)\n- ç”³è®ºé¢˜å‹\n  - [å½’çº³æ¦‚æ‹¬](/bbs/issue/85)',
                    mode: 'ir',
                    value: tocInitValue,
                    toolbar: ['list', 'ordered-list', '|', 'link', '|', 'undo', 'redo'],
                    cache: {
                        enable: true,
                        id: '{%if let Some(i)=issue%}issue-{{i.id}}-toc{%else%}new-issue-toc{%endif%}'
                    }
                });
                
                // ä¸»é¢˜åˆ‡æ¢æ”¯æŒ
                window.themeSwitcher.listener.push(function (dark) {
                    if (window.tocEditor) tocEditor.setTheme(dark ? 'dark' : 'light');
                });
            }
            
            // åˆå§‹åŒ–å…±ç”¨çš„å†…å®¹ç¼–è¾‘å™¨
            eEditor.style.background = 'url("' + window.loadingGif + '") center center no-repeat';
            
            // æ ¹æ®æ˜¯å¦ä¸ºåˆé›†é€‰æ‹©åˆå§‹å€¼
            var initValue = {%if let Some(i) = issue %}{%if i.collect%}{{ i.markdown | json | safe }}{%else%}{{ i.markdown | json | safe }}{%endif%}{%else%}''{% endif %};
            var initHeight = isCollect ? '70vh' : '100vh';
            
            window.vEditor = createVditor(eEditor, {
                height: initHeight,
                placeholder: 'åœ¨è¿™é‡Œè¾“å…¥æ–‡ç« å†…å®¹',
                mode: 'wysiwyg',
                value: initValue || '',
                counter: {
                    enable: true,
                    type: 'markdown'
                },
                toolbar: ['emoji', 'headings', 'bold', 'italic', 'strike',
                    '|', 'line', 'quote', 'list', 'ordered-list', 'check', 'outdent', 'indent', 'code', 'inline-code', 'table',
                    '|', 'undo', 'redo', 'upload', 'edit-mode', 'fullscreen', 'preview'
                ],
                toolbarConfig: {
                    pin: true
                },
                cache: {
                    enable: true,
                    id: '{%if let Some(i)=issue%}issue-{{i.id}}{%else%}new-issue{%endif%}'
                },
                focus() {
                    $("#editor").tooltip('toggle').attr("data-original-title", "").tooltip("hide");
                },
                after() {
                    $('button[data-type="preview"]').click(function () {
                        $("#submit").toggleClass('d-none');
                        $("#preview").toggleClass('d-none');
                    });
                    
                    // åˆå§‹åŒ–æ˜¾ç¤ºçŠ¶æ€
                    if (isCollect) {
                        $('#collect-toc-container').show();
                        initTocEditor();
                    }
                    
                    // vEditor åˆå§‹åŒ–å®Œæˆåå†ç»‘å®šå¤é€‰æ¡†äº‹ä»¶
                    $('#collect-checkbox').change(toggleEditor);
                }
            });
            
            window.themeSwitcher.listener.push(function (dark) {
                vEditor.setTheme(dark ? 'dark' : 'light');
            });
            $("#preview").click(function () {
                $('button[data-type="preview"]').click();
            });
            $("#form").submit(function (e) {
                if (!this.topic.value) {
                    e.preventDefault();
                    return false;
                }
                if (!this.title.value) {
                    e.preventDefault();
                    return false;
                }
                
                var isCollectMode = $('#collect-checkbox').is(':checked');
                
                if (isCollectMode) {
                    // åˆé›†æ¨¡å¼ï¼šä» TOC ç¼–è¾‘å™¨å’Œå…±ç”¨ç¼–è¾‘å™¨è·å–å†…å®¹
                    var toc = window.tocEditor ? window.tocEditor.getValue() : '';
                    var content = window.vEditor.getValue();
                    
                    if (!toc || !toc.trim()) {
                        alert("åˆé›†ç›®å½• (TOC) ä¸èƒ½ä¸ºç©º");
                        e.preventDefault();
                        return false;
                    }
                    
                    if (!content || !content.trim()) {
                        alert("åˆé›†å°é¢å†…å®¹ (Content) ä¸èƒ½ä¸ºç©º");
                        e.preventDefault();
                        return false;
                    }
                    
                    // ç»„è£… markdown ä¸º JSONï¼ˆåŒ…å« toc å’Œ contentï¼‰
                    var collectJson = JSON.stringify({
                        toc: toc,
                        content: content
                    });
                    
                    // è·å– content çš„ HTML ç‰ˆæœ¬ä¿å­˜åˆ° html å­—æ®µ
                    var contentHtml = window.vEditor.getHTML();
                    
                    $("<input />").attr("type", "hidden")
                        .attr("name", "markdown")
                        .attr("value", collectJson)
                        .appendTo("#form");
                    $("<input />").attr("type", "hidden")
                        .attr("name", "html")
                        .attr("value", contentHtml)
                        .appendTo("#form");
                    
                    // æ¸…é™¤ç¼“å­˜
                    if (window.tocEditor) window.tocEditor.clearCache();
                    window.vEditor.clearCache();
                    
                    return true;
                } else {
                    // æ™®é€šæ¨¡å¼ï¼šä½¿ç”¨ vEditor çš„å†…å®¹
                    var md = vEditor.getValue();
                    if (!md || !md.trim()) {
                        $("#editor").tooltip('hide').attr("data-original-title", "å¿…å¡«å†…å®¹").tooltip("show");
                        e.preventDefault();
                        return false;
                    } else {
                        $("<input />").attr("type", "hidden")
                            .attr("name", "markdown")
                            .attr("value", md)
                            .appendTo("#form");
                        $("<input />").attr("type", "hidden")
                            .attr("name", "html")
                            .attr("value", $(".vditor-preview .vditor-reset").html())
                            .appendTo("#form");
                        vEditor.clearCache();
                        return true;
                    }
                }
            });
        })
    </script>
</body>

</html>