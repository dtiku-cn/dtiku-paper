{% macro qr_code_script(width) %}
<script src='/static/vendor/qrcodejs-1.0.0/qrcode.min.js'></script>
<script>
    $(function () {
        function isMobile() {
            const ua = navigator.userAgent || navigator.vendor || window.opera;

            // 常见移动端关键字
            const mobileRegex = /android|iphone|ipad|ipod|blackberry|iemobile|opera mini|mobi/i;

            if (mobileRegex.test(ua)) {
                return true;
            }

            // 兜底：小屏幕也视为移动端
            if (window.innerWidth <= 768) {
                return true;
            }

            return false;
        }
        function encodeQrCodeUrl(text) {
            if (text.startsWith("http") || text.startsWith("wxp:")) {
                return text;
            }
            if (location.host.startsWith('localhost')) {
                return location.host + text;
            } else {
                return "https://p.hufeifei.cn" + text;
            }
        }

        $('.qrcode').each(function (i, e) {
            var $e = $(e);
            var text = $e.data('qrcode');
            var url = encodeQrCodeUrl(text);
            $e.data('qrcode-instance', new QRCode(e, {
                text: url,
                width: {{width}},
                height: {{width}},
                colorDark: "#000000",
                colorLight: "#ffffff",
                correctLevel: QRCode.CorrectLevel.H,
                logoWidth: 32,
                logoHeight: 32
            }));
            if ($e.data('icon')) {
                var style = 'position:absolute;' +
                    'overflow: hidden;' +
                    'font-size: 50px;' +
                    'width:32px;' +
                    'height:32px;' +
                    'top:50%;' +
                    'left:50%;' +
                    'margin-left:-16px;' +
                    'margin-top:-15px;' +
                    'border-radius: 4px;' +
                    'background: white;';
                $e.css("position", "relative").append("<svg style='" + style + "'>\n" +
                    "<use xlink:href=\"#ic-" + $e.data('icon') + "\"></use>\n" +
                    "</svg>");
            }

            if (isMobile()) {
                window.location.href = url;
            }
        })
    })
</script>
{% endmacro qr_code_script %}